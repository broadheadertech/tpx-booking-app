import React, { useEffect, useMemo, useRef, useState } from 'react'
import { useMutation, useQuery } from 'convex/react'
import { api } from '../../../convex/_generated/api'
import { Palette, RefreshCw, Eye, Undo2, Sparkles, Image as ImageIcon, ToggleLeft, ShieldCheck, Clock3, History, Download, Upload, AlertCircle } from 'lucide-react'
import { useAuth } from '../../context/AuthContext'
import { useBranding } from '../../context/BrandingContext'
import ConfirmDialog from '../common/ConfirmDialog'

const DEFAULT_BRANDING = {
  display_name: 'TipunoX',
  primary_color: 'var(--color-primary)',
  accent_color: 'var(--color-accent)',
  bg_color: 'var(--color-bg)',
  text_color: '#FFFFFF',
  muted_color: '#333333',
  logo_light_url: '/img/tipuno_x_logo_white.avif',
  logo_dark_url: '/img/tipuno_x_logo_white.avif',
  favicon_url: '/img/app_logo.png',
  banner_url: '',
  feature_toggles: {
    kiosk: true,
    wallet: true,
    vouchers: true,
    referrals: false,
  },
}

const FEATURE_KEYS = [
  { key: 'kiosk', label: 'Kiosk Mode' },
  { key: 'wallet', label: 'Wallet' },
  { key: 'vouchers', label: 'Vouchers' },
  { key: 'referrals', label: 'Referrals' },
]

const COLOR_PRESETS = [
  { name: 'Default Orange', primary: '#FF8C42', accent: '#FF7A2B' },
  { name: 'Blue Ocean', primary: '#3B82F6', accent: '#0EA5E9' },
  { name: 'Purple Dream', primary: '#A855F7', accent: '#8B5CF6' },
  { name: 'Green Forest', primary: '#10B981', accent: '#059669' },
  { name: 'Red Passion', primary: '#EF4444', accent: '#DC2626' },
  { name: 'Pink Bliss', primary: '#EC4899', accent: '#DB2777' },
]

// Frontend validation
const validateColor = (color) => {
  if (!color || typeof color !== 'string') return 'Color is required'
  if (/^#[0-9A-F]{3}([0-9A-F]{3})?$/i.test(color)) return null
  if (/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/i.test(color)) return null
  if (/^rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*[\d.]+\s*\)$/i.test(color)) return null
  if (/^var\(--[\w-]+\)$/.test(color)) return null
  return 'Invalid color format (use #RRGGBB, rgb(...), or var(--name))'
}

const validateUrl = (url) => {
  if (!url) return null // Optional field
  if (url.startsWith('/')) return null
  try {
    const parsed = new URL(url)
    if (parsed.protocol === 'http:' || parsed.protocol === 'https:') return null
    return 'URL must use http:// or https://'
  } catch {
    return 'Invalid URL format'
  }
}

const LabelValue = ({ label, value }) => (
  <div>
    <p className="text-xs uppercase tracking-wide text-gray-400">{label}</p>
    <p className="text-sm font-semibold text-white truncate">{value || '—'}</p>
  </div>
)

const ColorSwatch = ({ label, color }) => (
  <div className="flex items-center gap-3">
    <div className="w-10 h-10 rounded-xl border border-white/5 shadow-inner" style={{ backgroundColor: color }} />
    <div>
      <p className="text-xs uppercase text-gray-400">{label}</p>
      <p className="text-sm font-semibold text-white">{color || '—'}</p>
    </div>
  </div>
)

const ToggleRow = ({ label, enabled, onToggle, disabled }) => (
  <div className="flex items-center justify-between py-2">
    <div>
      <p className="text-sm font-semibold text-white">{label}</p>
      <p className="text-xs text-gray-400">Controls {label.toLowerCase()} visibility</p>
    </div>
    <button
      type="button"
      onClick={onToggle}
      disabled={disabled}
      className={`relative inline-flex h-7 w-12 items-center rounded-full transition-colors disabled:opacity-50 ${
        enabled ? 'bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-accent)]' : 'bg-gray-600'
      }`}
    >
      <span
        className={`inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform ${
          enabled ? 'translate-x-6' : 'translate-x-1'
        }`}
      />
    </button>
  </div>
)

const ColorInput = ({ label, value, onChange, disabled }) => (
  <label className="block space-y-2">
    <span className="text-sm font-medium text-gray-300">{label}</span>
    <div className="flex items-center gap-3">
      <input
        type="color"
        value={value || ''}
        disabled={disabled}
        onChange={(e) => onChange(e.target.value)}
        className="h-12 w-16 rounded-lg border border-white/10 bg-transparent"
      />
      <input
        type="text"
        value={value || ''}
        disabled={disabled}
        onChange={(e) => onChange(e.target.value)}
        placeholder="var(--color-primary)"
        className="flex-1 rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]/60 disabled:opacity-60"
      />
    </div>
  </label>
)

const UrlInput = ({ label, value, onChange, placeholder, disabled }) => (
  <label className="block space-y-2">
    <span className="text-sm font-medium text-gray-300">{label}</span>
    <input
      type="text"
      value={value || ''}
      disabled={disabled}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]/60 disabled:opacity-60"
    />
  </label>
)

const ALLOWED_FIELDS = new Set([
  'display_name',
  'primary_color',
  'accent_color',
  'bg_color',
  'text_color',
  'muted_color',
  'logo_light_url',
  'logo_dark_url',
  'favicon_url',
  'banner_url',
  'feature_toggles',
])

const FEATURE_KEYS_ALLOWED = ['kiosk', 'wallet', 'vouchers', 'referrals']

const sanitizePayload = (form) => {
  const payload = {}
  ALLOWED_FIELDS.forEach((key) => {
    const value = form[key]
    if (value === undefined || value === null || value === '') return
    if (key === 'feature_toggles') {
      const toggles = {}
      FEATURE_KEYS_ALLOWED.forEach((toggleKey) => {
        const toggleValue = value?.[toggleKey]
        if (typeof toggleValue === 'boolean') {
          toggles[toggleKey] = toggleValue
        }
      })
      if (Object.keys(toggles).length) {
        payload.feature_toggles = toggles
      }
      return
    }
    if (typeof value === 'string') {
      const trimmed = value.trim()
      if (trimmed) payload[key] = trimmed
      return
    }
    payload[key] = value
  })
  return payload
}

const formatTimestamp = (timestamp) => {
  if (!timestamp) return 'Not yet updated'
  return new Date(timestamp).toLocaleString()
}

export default function BrandingManagement() {
  const { user, sessionToken } = useAuth()
  const { branding: activeBranding, loading: brandingLoading, error: brandingError, refresh: refreshBranding } = useBranding()
  const upsertGlobalBranding = useMutation(api.services.branding.upsertGlobalBranding)
  const rollbackGlobalBranding = useMutation(api.services.branding.rollbackGlobalBranding)
  const exportBranding = useQuery(canEdit && sessionToken ? api.services.branding.exportBranding : null, canEdit && sessionToken ? { sessionToken } : 'skip')
  const brandingHistory = useQuery(canEdit && sessionToken ? api.services.branding.getBrandingHistory : null, canEdit && sessionToken ? { sessionToken, limit: 10 } : 'skip')
  const importBrandingMutation = useMutation(api.services.branding.importBranding)
  
  const [form, setForm] = useState(() => ({ ...DEFAULT_BRANDING, ...(activeBranding || {}) }))
  const [isEditing, setIsEditing] = useState(false)
  const [saving, setSaving] = useState(false)
  const [status, setStatus] = useState(null)
  const [validationErrors, setValidationErrors] = useState({})
  const [confirmDialog, setConfirmDialog] = useState(null)
  const [showHistory, setShowHistory] = useState(false)
  const [importing, setImporting] = useState(false)
  const previewRef = useRef(null)
  const fileInputRef = useRef(null)
  const canEdit = user?.role === 'super_admin'

  useEffect(() => {
    if (!isEditing) {
      setForm({ ...DEFAULT_BRANDING, ...(activeBranding || {}) })
    }
  }, [activeBranding, isEditing])

  const handleToggle = (key) => {
    if (!canEdit || !isEditing) return
    setForm((prev) => ({
      ...prev,
      feature_toggles: {
        ...(prev.feature_toggles || {}),
        [key]: !prev.feature_toggles?.[key],
      },
    }))
  }

  const handleSave = async () => {
    if (!canEdit || !isEditing || !sessionToken) return
    setSaving(true)
    setStatus(null)
    try {
      await upsertGlobalBranding({
        sessionToken,
        payload: sanitizePayload(form),
      })
      setStatus({ type: 'success', message: 'Branding updated successfully.' })
      setIsEditing(false)
      refreshBranding()
    } catch (error) {
      setStatus({ type: 'error', message: error.message || 'Failed to update branding.' })
    } finally {
      setSaving(false)
    }
  }

  const handleReset = () => {
    if (!canEdit || !isEditing) return
    setForm(DEFAULT_BRANDING)
    setStatus({ type: 'info', message: 'Reverted to default values. Save to apply.' })
  }

  const summaryBranding = useMemo(() => ({ ...DEFAULT_BRANDING, ...(activeBranding || {}) }), [activeBranding])

  const previewStyles = useMemo(() => ({
    '--color-primary': form.primary_color,
    '--color-accent': form.accent_color,
    '--color-bg': form.bg_color,
    '--color-text': form.text_color,
  }), [form])

  return (
    <section className="space-y-10">
      <header className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <p className="text-sm font-semibold text-[var(--color-primary)] uppercase tracking-wide">Branding Control</p>
          <h2 className="mt-2 flex items-center gap-3 text-3xl font-extrabold text-white">
            <span className="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-[var(--color-primary)] to-[var(--color-accent)] text-white shadow-lg">
              <Palette className="h-6 w-6" />
            </span>
            Global Branding Management
          </h2>
          <p className="mt-2 text-sm text-gray-400">Configure the single source of truth for colors, media assets, and feature toggles across every experience.</p>
        </div>
        <div className="flex flex-wrap gap-3">
          <button
            type="button"
            onClick={() => previewRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' })}
            className="inline-flex items-center gap-2 rounded-2xl border border-white/10 px-5 py-3 text-sm font-semibold text-white transition hover:border-white/30"
          >
            <Eye className="h-4 w-4" />
            Preview
          </button>
          {canEdit && (
            <>
              <button
                type="button"
                onClick={handleReset}
                disabled={!isEditing}
                className="inline-flex items-center gap-2 rounded-2xl border border-white/10 px-5 py-3 text-sm font-semibold text-white transition hover:border-white/30 disabled:cursor-not-allowed disabled:opacity-40"
              >
                <Undo2 className="h-4 w-4" />
                Reset Defaults
              </button>
              <button
                type="button"
                onClick={() => {
                  setStatus(null)
                  setForm({ ...DEFAULT_BRANDING, ...(activeBranding || {}) })
                  setIsEditing(true)
                }}
                className={`inline-flex items-center gap-2 rounded-2xl px-6 py-3 text-sm font-semibold text-white shadow-lg ${
                  isEditing
                    ? 'bg-white/10 text-white'
                    : 'bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-accent)]'
                }`}
              >
                <Sparkles className="h-4 w-4" />
                {isEditing ? 'Editing' : 'Edit Branding'}
              </button>
            </>
          )}
        </div>
      </header>

      {status && (
        <div
          className={`rounded-2xl border px-4 py-3 text-sm font-semibold ${
            status.type === 'success'
              ? 'border-green-500/40 bg-green-500/10 text-green-200'
              : status.type === 'error'
                ? 'border-red-500/40 bg-red-500/10 text-red-200'
                : 'border-white/10 bg-white/5 text-gray-200'
          }`}
        >
          {status.message}
        </div>
      )}

      {/* Summary Cards */}
      <div className="grid gap-6 lg:grid-cols-3">
        <div className="rounded-3xl border border-white/10 bg-[var(--color-bg)]/40 p-6 shadow-xl">
          <div className="flex items-center justify-between">
            <p className="text-sm font-semibold text-gray-400">Display</p>
            <ShieldCheck className="h-5 w-5 text-[var(--color-primary)]" />
          </div>
          <p className="mt-2 text-2xl font-bold text-white">{summaryBranding.display_name || 'Not set'}</p>
          <div className="mt-4 grid gap-3">
            <LabelValue label="Updated" value={formatTimestamp(summaryBranding.updatedAt || summaryBranding.updated_at)} />
            <LabelValue label="Identifier" value={summaryBranding._id || 'Singleton'} />
          </div>
        </div>

        <div className="rounded-3xl border border-white/10 bg-[var(--color-bg)]/40 p-6 shadow-xl">
          <p className="text-sm font-semibold text-gray-400">Color Tokens</p>
          <div className="mt-4 space-y-4">
            <ColorSwatch label="Primary" color={summaryBranding.primary_color} />
            <ColorSwatch label="Accent" color={summaryBranding.accent_color} />
            <ColorSwatch label="Background" color={summaryBranding.bg_color} />
          </div>
        </div>

        <div className="rounded-3xl border border-white/10 bg-[var(--color-bg)]/40 p-6 shadow-xl">
          <p className="text-sm font-semibold text-gray-400">Feature Toggles</p>
          <div className="mt-4 grid grid-cols-2 gap-3 text-sm font-semibold text-white">
            {FEATURE_KEYS.map(({ key, label }) => (
              <div key={key} className="flex items-center gap-2">
                <ToggleLeft className={`h-4 w-4 ${summaryBranding.feature_toggles?.[key] ? 'text-[var(--color-primary)]' : 'text-gray-500'}`} />
                <span>{label}</span>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Media */}
      <div className="grid gap-6 lg:grid-cols-2">
        <div className="rounded-3xl border border-white/10 bg-[var(--color-bg)]/40 p-6">
          <div className="flex items-center gap-3">
            <span className="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-white/5 text-white">
              <ImageIcon className="h-5 w-5" />
            </span>
            <div>
              <p className="text-sm font-semibold text-gray-400">Media Assets</p>
              <p className="text-lg font-bold text-white">Logos & Favicon</p>
            </div>
          </div>
          <div className="mt-6 space-y-4 text-sm text-gray-300">
            <LabelValue label="Logo (Light)" value={summaryBranding.logo_light_url} />
            <LabelValue label="Logo (Dark)" value={summaryBranding.logo_dark_url} />
            <LabelValue label="Favicon" value={summaryBranding.favicon_url} />
          </div>
        </div>

        <div
          ref={previewRef}
          className="rounded-3xl border border-white/10 bg-gradient-to-br from-[var(--color-bg)] to-black/60 p-6"
          style={previewStyles}
        >
          <p className="text-sm font-semibold text-gray-400">Live Preview</p>
          <div className="mt-4 flex items-center gap-4 rounded-2xl bg-black/20 p-4">
            <img src={form.logo_light_url} alt="Logo preview" className="h-12 w-12 rounded-xl object-contain" />
            <div>
              <p className="text-lg font-bold text-[var(--color-text)]">{form.display_name || 'Brand Preview'}</p>
              <p className="text-sm text-[var(--color-muted)]">System-wide tokens</p>
            </div>
          </div>
          <div className="mt-6 h-12 rounded-2xl bg-[var(--color-primary)] shadow-inner" />
        </div>
      </div>

      {/* Editor */}
      <div className="rounded-3xl border border-white/10 bg-[var(--color-bg)]/60 p-6 shadow-2xl">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm font-semibold text-gray-400">Editor</p>
            <h3 className="text-xl font-bold text-white">Branding Details</h3>
          </div>
          <div className="text-xs font-semibold uppercase tracking-widest text-gray-500">
            {canEdit ? (isEditing ? 'Editing Mode' : 'Super Admin Access') : 'Read Only'}
          </div>
        </div>

        <div className="mt-6 grid gap-6 lg:grid-cols-2">
          <div className="space-y-5">
            <UrlInput
              label="Display Name"
              value={form.display_name}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, display_name: v }))}
              placeholder="Brand name"
            />
            <ColorInput
              label="Primary Color"
              value={form.primary_color}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, primary_color: v }))}
            />
            <ColorInput
              label="Accent Color"
              value={form.accent_color}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, accent_color: v }))}
            />
            <ColorInput
              label="Background Color"
              value={form.bg_color}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, bg_color: v }))}
            />
            <ColorInput
              label="Text Color"
              value={form.text_color}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, text_color: v }))}
            />
            <ColorInput
              label="Muted Color"
              value={form.muted_color}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, muted_color: v }))}
            />
          </div>

          <div className="space-y-5">
            <UrlInput
              label="Logo (Light) URL"
              value={form.logo_light_url}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, logo_light_url: v }))}
              placeholder="https://domain/logo-light.png"
            />
            <UrlInput
              label="Logo (Dark) URL"
              value={form.logo_dark_url}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, logo_dark_url: v }))}
              placeholder="https://domain/logo-dark.png"
            />
            <UrlInput
              label="Favicon URL"
              value={form.favicon_url}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, favicon_url: v }))}
              placeholder="https://domain/favicon.ico"
            />
            <UrlInput
              label="Banner URL"
              value={form.banner_url}
              disabled={!canEdit || !isEditing}
              onChange={(v) => setForm((prev) => ({ ...prev, banner_url: v }))}
              placeholder="https://domain/banner.png"
            />

            <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
              <div className="flex items-center gap-2">
                <Clock3 className="h-4 w-4 text-[var(--color-primary)]" />
                <p className="text-sm font-semibold text-white">Live Modules</p>
              </div>
              <p className="mt-1 text-xs text-gray-400">Toggle experiences for all clients.</p>
              <div className="mt-4 space-y-3">
                {FEATURE_KEYS.map(({ key, label }) => (
                  <ToggleRow
                    key={key}
                    label={label}
                    enabled={!!form.feature_toggles?.[key]}
                    onToggle={() => handleToggle(key)}
                    disabled={!canEdit || !isEditing}
                  />
                ))}
              </div>
            </div>
          </div>
        </div>

        {canEdit && isEditing && (
          <div className="mt-6 flex flex-wrap gap-3">
            <button
              type="button"
              onClick={() => {
                setIsEditing(false)
                setForm({ ...DEFAULT_BRANDING, ...(activeBranding || {}) })
              }}
              className="inline-flex items-center gap-2 rounded-2xl border border-white/10 px-5 py-3 text-sm font-semibold text-white"
            >
              Cancel
            </button>
            <button
              type="button"
              onClick={handleSave}
              disabled={saving}
              className="inline-flex items-center gap-2 rounded-2xl bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-accent)] px-6 py-3 text-sm font-semibold text-white shadow-lg disabled:opacity-60"
            >
              {saving ? (
                <>
                  <RefreshCw className="h-4 w-4 animate-spin" />
                  Saving...
                </>
              ) : (
                <>
                  <RefreshCw className="h-4 w-4" />
                  Save Changes
                </>
              )}
            </button>
          </div>
        )}
      </div>
    </section>
  )
}